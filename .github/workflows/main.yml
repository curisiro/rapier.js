name: Build & Publish Rapier Compat

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0
        with:
          version: 'latest'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@${{ github.repository_owner }}'

      - name: Install Build Dependencies
        run: |
          npm install typescript -g
          if [ -f "package.json" ]; then npm install; fi

      # B∆∞·ªõc n√†y t·∫°o ra c√°c folder project v√† Cargo.toml g·ªëc
      - name: Prepare Projects
        run: |
          chmod +x ./builds/prepare_builds/*.sh
          ./builds/prepare_builds/prepare_all_projects.sh

      # --- PH·∫¶N QUAN TR·ªåNG ƒê√É S·ª¨A ƒê·ªîI ---
      # S·ª≠ d·ª•ng Node.js ƒë·ªÉ patch file an to√†n h∆°n sed, x·ª≠ l√Ω ƒë∆∞·ª£c ƒëa d√≤ng
      - name: Patch Cargo.toml (Node.js script)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // H√†m ƒë·ªá quy t√¨m t·∫•t c·∫£ file Cargo.toml
            function findFiles(dir, fileList = []) {
              const files = fs.readdirSync(dir);
              files.forEach(file => {
                const filePath = path.join(dir, file);
                const stat = fs.statSync(filePath);
                if (stat.isDirectory()) {
                  if (file !== 'node_modules' && file !== '.git' && file !== 'target') {
                    findFiles(filePath, fileList);
                  }
                } else if (file === 'Cargo.toml') {
                  fileList.push(filePath);
                }
              });
              return fileList;
            }

            const cargoFiles = findFiles('./builds'); // Ch·ªâ t√¨m trong folder builds ƒë√£ generate
            console.log("Found Cargo.toml files:", cargoFiles);

            cargoFiles.forEach(file => {
              let content = fs.readFileSync(file, 'utf8');
              
              // Regex t√¨m kh·ªëi rapier dependency (x·ª≠ l√Ω c·∫£ multi-line)
              // T√¨m rapier2d ho·∫∑c rapier3d, theo sau l√† d·∫•u = v√† kh·ªëi {}
              const regex = /(rapier[23]d)\s*=\s*\{[\s\S]*?\}/g;
              
              // Thay th·∫ø b·∫±ng git dependency c·ªßa b·∫°n
              // L∆∞u √Ω: Ph·∫£i gi·ªØ feature "serde-serialize" v√¨ log l·ªói cho th·∫•y n√≥ c·∫ßn thi·∫øt
              const replacement = (match, p1) => {
                 return `${p1} = { git = "https://github.com/curisiro/rapier", tag = "v0.30.1", features = ["wasm-bindgen", "serde-serialize"] }`;
              };

              if (regex.test(content)) {
                console.log(`Patching ${file}...`);
                const newContent = content.replace(regex, replacement);
                fs.writeFileSync(file, newContent);
              } else {
                console.log(`Skipping ${file} (No rapier dependency found matching pattern)`);
              }
            });

      # --- K·∫æT TH√öC PH·∫¶N S·ª¨A ---

      - name: Build Original WASM
        run: |
          echo "üîπ Building original WASM packages..."
          # Script n√†y s·∫Ω g·ªçi cargo build
          ./builds/prepare_builds/build_all_projects.sh

      - name: Build Compat Version
        run: |
          echo "üîπ Building Compat packages..."
          cd rapier-compat
          npm install
          npm run build

      - name: Publish rapier3d-compat
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîπ Processing rapier3d-compat..."
          
          # T√¨m folder output (th∆∞·ªùng l√† gen/rapier3d-compat)
          TARGET_DIR=$(find rapier-compat -type d -name "rapier3d-compat" | grep "gen" | head -n 1)
          
          if [ -z "$TARGET_DIR" ]; then
             TARGET_DIR=$(find rapier-compat -type d -name "rapier3d-compat" | head -n 1)
          fi
          
          if [ -z "$TARGET_DIR" ]; then
            echo "‚ùå Error: Could not find build output for rapier3d-compat"
            # Debug: List c·∫•u tr√∫c file ƒë·ªÉ xem n√≥ n·∫±m ƒë√¢u
            find rapier-compat -maxdepth 4
            exit 1
          fi
          
          echo "Found build at: $TARGET_DIR"
          cd $TARGET_DIR
          
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          NEW_NAME="@$OWNER/rapier3d-compat"
          
          echo "Renaming package to: $NEW_NAME"
          npm pkg set name="$NEW_NAME"
          
          npm publish
          echo "‚úÖ Published $NEW_NAME successfully!"