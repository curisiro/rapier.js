name: Build & Publish Rapier Compat

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write # C·∫•p quy·ªÅn ƒë·ªÉ publish package l√™n GitHub

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout Code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. C√†i ƒë·∫∑t Rust & Target WASM
      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      # 3. C√†i ƒë·∫∑t wasm-pack (C√¥ng c·ª• build Rust sang WASM)
      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0
        with:
          version: 'latest'

      # 4. C√†i ƒë·∫∑t Node.js & C·∫•u h√¨nh Registry GitHub
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@${{ github.repository_owner }}'

      - name: Install Build Dependencies
        run: |
          npm install typescript -g
          # C√†i dependency g·ªëc n·∫øu c√≥
          if [ -f "package.json" ]; then npm install; fi

      # 5. Ch·∫°y Prepare Script & Patch Version Core
      - name: Prepare and Patch Rapier Core to v0.30.1
        run: |
          chmod +x ./builds/prepare_builds/*.sh
          
          # Ch·∫°y prepare ƒë·ªÉ sinh ra c√°c file Cargo.toml c·∫ßn thi·∫øt
          ./builds/prepare_builds/prepare_all_projects.sh
          
          echo "üîπ Patching Cargo.toml files to use curisiro/rapier v0.30.1..."
          
          # T√¨m t·∫•t c·∫£ file Cargo.toml v√† thay th·∫ø dependency
          find . -name "Cargo.toml" -type f | while read file; do
            # Patch cho rapier3d
            sed -i 's|^rapier3d = .*|rapier3d = { git = "https://github.com/curisiro/rapier", tag = "v0.30.1", features = ["wasm-bindgen"] }|g' "$file"
            # Patch cho rapier2d (ƒë·ªÉ tr√°nh l·ªói n·∫øu build script check c·∫£ 2)
            sed -i 's|^rapier2d = .*|rapier2d = { git = "https://github.com/curisiro/rapier", tag = "v0.30.1", features = ["wasm-bindgen"] }|g' "$file"
          done
          
          echo "‚úÖ Patch completed."

      # 6. Build WASM g·ªëc (Input cho b∆∞·ªõc Compat)
      - name: Build Original WASM
        run: |
          echo "üîπ Building original WASM packages..."
          ./builds/prepare_builds/build_all_projects.sh

      # 7. Build Compat Version (Nh√∫ng WASM v√†o JS)
      - name: Build Compat Version
        run: |
          echo "üîπ Building Compat packages..."
          cd rapier-compat
          npm install
          npm run build
          # Script n√†y s·∫Ω t·∫°o ra output t·∫°i th∆∞ m·ª•c rapier-compat/gen/ ho·∫∑c rapier-compat/pkg/

      # 8. Publish rapier3d-compat
      - name: Publish rapier3d-compat
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîπ Processing rapier3d-compat..."
          
          # T√¨m th∆∞ m·ª•c ch·ª©a package.json c·ªßa rapier3d-compat v·ª´a build
          # Th∆∞·ªùng n·∫±m trong rapier-compat/gen
          TARGET_DIR=$(find rapier-compat -type d -name "rapier3d-compat" | grep "gen" | head -n 1)
          
          if [ -z "$TARGET_DIR" ]; then
             # Fallback t√¨m ki·∫øm r·ªông h∆°n n·∫øu c·∫•u tr√∫c thay ƒë·ªïi
             TARGET_DIR=$(find rapier-compat -type d -name "rapier3d-compat" | head -n 1)
          fi
          
          if [ -z "$TARGET_DIR" ]; then
            echo "‚ùå Error: Kh√¥ng t√¨m th·∫•y th∆∞ m·ª•c build rapier3d-compat"
            exit 1
          fi
          
          echo "Found build at: $TARGET_DIR"
          cd $TARGET_DIR
          
          # ƒê·ªïi t√™n package th√†nh @username/rapier3d-compat
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          NEW_NAME="@$OWNER/rapier3d-compat"
          
          echo "Renaming package to: $NEW_NAME"
          npm pkg set name="$NEW_NAME"
          
          # Publish l√™n GitHub Packages
          npm publish
          echo "‚úÖ Published $NEW_NAME successfully!"

      # 9. (T√πy ch·ªçn) Publish rapier2d-compat n·∫øu c·∫ßn
      - name: Publish rapier2d-compat
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true # Kh√¥ng fail workflow n·∫øu kh√¥ng c·∫ßn 2d
        run: |
          echo "üîπ Processing rapier2d-compat..."
          TARGET_DIR=$(find rapier-compat -type d -name "rapier2d-compat" | grep "gen" | head -n 1)
          
          if [ -n "$TARGET_DIR" ]; then
            cd $TARGET_DIR
            OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
            NEW_NAME="@$OWNER/rapier2d-compat"
            npm pkg set name="$NEW_NAME"
            npm publish
            echo "‚úÖ Published $NEW_NAME successfully!"
          else
            echo "‚ö†Ô∏è rapier2d-compat not found, skipping."
          fi